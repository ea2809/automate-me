#!/usr/bin/env bash
set -euo pipefail

cmd=${1:-}

if [[ "$cmd" == "describe" ]]; then
  python3 - <<'PY'
import json
import os

projects_dir = os.path.expanduser(os.getenv("AUTOMATE_ME_PROJECTS_DIR", "~/projects"))
choices = []
if os.path.isdir(projects_dir):
  for name in sorted(os.listdir(projects_dir)):
    full = os.path.join(projects_dir, name)
    if os.path.isdir(full):
      choices.append(name)

manifest = {
  "schemaVersion": 1,
  "plugin": {
    "id": "projects",
    "title": "Projects",
    "version": "0.1.0"
  },
  "tasks": [
    {
      "name": "ls",
      "title": "List project files",
      "group": "Projects",
      "description": "Select a project and run ls",
      "inputs": [
        {
          "name": "project",
          "type": "enum",
          "required": True,
          "prompt": "Project",
          "choices": choices
        }
      ]
    }
  ]
}

print(json.dumps(manifest))
PY
  exit 0
fi

if [[ "$cmd" == "run" ]]; then
  task=${2:-}
  if [[ "$task" != "ls" ]]; then
    echo "unknown task: $task" >&2
    exit 1
  fi

  python3 -c '
import json
import os
import sys

raw = sys.stdin.read()
payload = json.loads(raw) if raw.strip() else {}
project = payload.get("args", {}).get("project")
if not project:
  print("missing required input: project", file=sys.stderr)
  sys.exit(1)

projects_dir = os.path.expanduser(os.getenv("AUTOMATE_ME_PROJECTS_DIR", "~/projects"))
path = os.path.join(projects_dir, project)
if not os.path.isdir(path):
  print(f"project not found: {path}", file=sys.stderr)
  sys.exit(1)

os.execvp("ls", ["ls", path])
'
  exit 0
fi

echo "usage: $0 describe|run <task>" >&2
exit 1
